---
title: "Multi-Environment Deployment Strategies"
description: "Describes how to set up and manage separate development, staging, and production environments for seamless CI/CD and reliable rollouts. Outlines environment scoping, environment-specific overrides, and how to automate multi-cluster or regionally segmented deployments."
---

# Multi-Environment Deployment Strategies

Seamlessly managing multiple deployment environments like development, staging, and production is vital for reliable rollouts and continuous integration/continuous delivery (CI/CD) of the Magic platform. This guide empowers you to set up, configure, and automate isolated environments—each with scoped configuration, environment-specific overrides, and flexible deployment options across clusters or regions.

---

## 1. Understanding Environment Scoping and Isolation

To ensure safe testing and stable production use, Magic supports fully isolated environments that run side-by-side without interference. Each environment holds independent configuration, credentials, and resource boundaries.

- **Development (Dev):** Frequent code changes, debugging enabled, verbose logging.
- **Staging (Test/Pre):** Pre-production validation, near-production settings, feature testing.
- **Production (Prod):** Hardened, performance-tuned, secure, and high availability.

### Why Environment Isolation Matters

- Prevent accidental cross-contamination of data or credentials.
- Allow parallel development and validation cycles.
- Support rollbacks without impacting live users.
- Enable environment-specific tuning for resources and security.

---

## 2. Structuring Environment-Specific Configuration

Magic uses environment variables, primarily managed via `.env` files, to control settings per deployment. Organize these files under dedicated directories for clarity and maintainability:

```plaintext
config/
├── dev/
│   └── .env       # Development-specific variables
├── test/
│   └── .env       # Testing/Staging environment
└── prod/
    └── .env       # Production environment
```

### Key Principles for `.env` Files

- **Consistency:** Share common configurations but always isolate secrets and tokens.
- **Overrides:** Set base variables globally and override in environment-specific `.env` files.
- **Security:** Never commit sensitive `.env` files to source control.
- **Versioning:** Track template `.env.example` for reference; keep environment files out of version control.

### Recommended Environment Variables

Here are critical variables you must configure differently per environment:

| Variable                 | Description                             | Recommendation                         |
|--------------------------|-------------------------------------|-------------------------------------|
| `APP_ENV`                 | Environment name (dev, test, prod)  | Set precisely per environment         |
| `JWT_SECRET`              | Token signing secret                 | Unique strong secrets per env         |
| `MAGIC_API_KEY`           | API key for internal/external access| Differ per environment                 |
| `ENABLE_MAGIC_WATCHDOG`   | Dev/debug watchdog                   | Enabled in dev/test, disabled prod    |
| `FILE_DRIVER`             | File storage driver (local/oss/tos) | Ensure prod uses stable cloud storage |
| `PORT`                    | Service listening port               | Unique port per env                    |

### Example snippet from `config/prod/.env`

```ini
APP_ENV=prod
JWT_SECRET=prod-jwt-secret-key-change-me
MAGIC_API_KEY=prod-xxx
ENABLE_MAGIC_WATCHDOG=false
FILE_DRIVER=oss
PORT=9501
```

---

## 3. Deploying Multiple Environment Instances with Docker

Isolation is best achieved via containerized deployments, enabling you to run multiple Magic instances simultaneously on a single host or across clusters.

### 3.1 Directory and Configuration Setup

Arrange the following directory structure for your deployment repository:

```plaintext
magic-deploy/
├── config/
│   ├── dev/.env
│   ├── test/.env
│   └── prod/.env
├── Dockerfile
├── docker-compose.yml
└── deploy.sh
```

### 3.2 Docker Compose: Multi-Environment Support

Your `docker-compose.yml` should dynamically select configuration based on environment variables. Here is a sample configuration:

```yaml
version: '3.8'
services:
  magic-service:
    build: .
    ports:
      - "${EXTERNAL_PORT:-9501}:${PORT:-9501}"
    environment:
      - APP_ENV=${APP_ENV}
      - JWT_SECRET=${JWT_SECRET}
      - MAGIC_API_KEY=${MAGIC_API_KEY}
      - FILE_DRIVER=${FILE_DRIVER}
    volumes:
      - ./config/${APP_ENV}/.env:/app/.env:ro
    restart: always
    networks:
      - magic-net

networks:
  magic-net:
    driver: bridge
```

This structure:
- Maps the environment-specific `.env` file into the container at runtime.
- Uses environment variables or defaults to specify ports and secrets.
- Allows parallel deployment of multiple environments on distinct ports.

### 3.3 Example: Launching the Production Environment

```bash
APP_ENV=prod \
PORT=9501 \
EXTERNAL_PORT=9501 \
JWT_SECRET=prod-jwt-secret-key-change-me \
MAGIC_API_KEY=prod-xxx \
docker-compose up -d
```

Repeat with different variables for dev and test environments.

---

## 4. Automating Multi-Environment Deployments

Manual environment switching is error-prone. Use scripts or tooling to automate environment selection and common operations.

### 4.1 Example Bash Script `deploy.sh`

```bash
#!/bin/bash

env=$1
operation=$2

if [[ ! "$env" =~ ^(dev|test|prod)$ ]]; then
  echo "Usage: $0 <dev|test|prod> <start|stop|restart|logs|status>"
  exit 1
fi

case $operation in
  start)
    echo "Starting $env environment..."
    APP_ENV=$env docker-compose up -d
    ;;
  stop)
    echo "Stopping $env environment..."
    APP_ENV=$env docker-compose down
    ;;
  restart)
    $0 $env stop
    $0 $env start
    ;;
  logs)
    APP_ENV=$env docker-compose logs -f
    ;;
  status)
    APP_ENV=$env docker-compose ps
    ;;
  *)
    echo "Unknown operation: $operation"
    exit 1
    ;;
esac
```

**Usage example:**

```bash
./deploy.sh prod start  # Start production environment
./deploy.sh test logs   # Tail logs on test environment
```

### Benefits
- Consistent operations for each environment.
- Rapid switching and status checks.
- Reduces mistakes, automates retries and rollbacks.

---

## 5. Multi-Cluster and Regional Deployments

For large scale or regionally segmented deployments:

- Deploy each environment to targeted clusters or cloud regions.
- Use CI/CD pipelines to push environment-specific artifacts.
- Automate secrets injection and scaling configurations per region.
- Implement health checks, monitoring, and alerting per environment cluster.
- Maintain configuration versioning via centralized tools (e.g. Vault, Kubernetes ConfigMaps).

Magic’s architecture supports this by isolating environment IDs and data to maintain security and consistency across deployments.

---

## 6. Best Practices and Recommendations

- **Use Strong, Unique Secrets per Environment:** Never share production secrets in dev or test.
- **Separate Data Stores:** Use distinct databases or namespaces per environment to prevent data leakage.
- **Immutable Image Tags:** Tag Docker images for environments to fixed versions for reproducibility.
- **Log and Monitor Separately:** Tailor logging verbosity to environment needs.
- **Use Environment Flags in Code:** Leverage `APP_ENV` to enable/disable debugging or feature flags.
- **Secure Production Access:** Use VPNs, HTTPS, and IP restrictions for prod.
- **Test Post-Deployment:** Verify environment variables and secrets loaded correctly after deployment.

---

## 7. Troubleshooting Common Issues

| Problem                               | Solution                                  |
|-------------------------------------|-------------------------------------------|
| Containers fail to pick up new `.env`| Restart containers after updating `.env`  |
| Port conflicts between envs           | Assign unique `EXTERNAL_PORT` per env       |
| Secrets leaked in repo                 | Use environment variable injection tools, ignore `.env` in VCS |
| Services not responding after deploy  | Check logs via `deploy.sh <env> logs` for errors |
| Unable to distinguish environment at runtime | Verify `APP_ENV` and config mount points |

---

## 8. Additional Resources

- [System Requirements & Preparation](../getting-started-deployment/system-requirements-and-preparation.md)
- [Configuring Environment Variables](../advanced-environment-configuration/configuring-environment-variables.md)
- [Quick Deployment with Docker](../getting-started-deployment/quick-deployment-with-docker.md)
- [Scaling & High Availability](../scaling-monitoring-and-resilience/scaling-and-high-availability.md)

---

Mastering multi-environment deployment strategies secures your Magic platform's reliability and promotes continuous delivery workflows, empowering seamless innovation from dev through production.

---

<Check>
Ensure every deployment environment maintains independent secrets and configurations to avoid operational risks.
</Check>

<Note>
Automate environment variable management and consider secrets management systems (e.g., HashiCorp Vault, Kubernetes Secrets) for production-grade security.
</Note>

<Tip>
Use CI/CD pipelines to automate builds and deployments to each environment, enabling repeatable, reliable rollouts with minimal manual intervention.
</Tip>
